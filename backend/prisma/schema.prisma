datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model School {
  id        Int      @id @default(autoincrement())
  name      String
  city      String?
  state     String?
  createdAt DateTime @default(now())

  students Student[]
}

model Campaign {
  id        Int      @id @default(autoincrement())
  name      String
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())

  students  Student[]
  messages  OutreachMessage[]
}

enum AreaOfInterest {
  COSMETOLOGY
  BARBER
  NAIL_TECHNICIAN
}

model Student {
  id               Int            @id @default(autoincrement())
  firstName        String
  lastName         String
  email            String?
  phone            String?
  createdAt        DateTime       @default(now())

  areaOfInterest   AreaOfInterest @default(COSMETOLOGY)

  // lifecycle flags (A)
  contacted        Boolean        @default(false)
  contactedAt      DateTime?
  visitCompleted   Boolean        @default(false)
  visitCompletedAt DateTime?

  schoolId         Int
  campaignId       Int

  school           School         @relation(fields: [schoolId], references: [id])
  campaign         Campaign       @relation(fields: [campaignId], references: [id])

  outreachLogs     OutreachLog[]
  tourVisits       TourVisit[]
}

enum TourStatus {
  SCHEDULED
  COMPLETED
  CANCELED
  NO_SHOW
}

model TourVisit {
  id         Int        @id @default(autoincrement())
  studentId  Int
  // Start time of the tour (store as UTC ideally)
  startsAt   DateTime
  status     TourStatus @default(SCHEDULED)
  notes      String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  student    Student    @relation(fields: [studentId], references: [id])

  @@index([startsAt])
  @@index([studentId])
  @@unique([startsAt]) // prevents double-booking same time slot
}

model OutreachMessage {
  id         Int      @id @default(autoincrement())
  studentId  Int
  campaignId Int
  message    String
  sentAt     DateTime @default(now())

  campaign   Campaign      @relation(fields: [campaignId], references: [id])
  logs       OutreachLog[]
}

model OutreachLog {
  id        Int            @id @default(autoincrement())
  sentAt    DateTime       @default(now())
  status    OutreachStatus

  studentId Int
  messageId Int

  student   Student         @relation(fields: [studentId], references: [id])
  message   OutreachMessage @relation(fields: [messageId], references: [id])
}

enum OutreachChannel {
  EMAIL
  SMS
}

enum OutreachStatus {
  SENT
  FAILED
}
